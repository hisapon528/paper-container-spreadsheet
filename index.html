<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç´™å®¹å™¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    padding: 20px;
    max-width: 980px;
    margin: auto;
  }
  h1 { font-size: 22px; margin-bottom: 8px; }
  .formula {
    font-family: "Cambria Math", "Times New Roman", serif;
    font-size: 28px;
    margin-bottom: 16px;
  }
  .section {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 20px;
  }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
  th { background-color: #f5f5f5; }

  input[type="number"] {
    width: 100%;
    box-sizing: border-box;
    padding: 4px 6px;
    text-align: right;
  }
  input[readonly] {
    background: #f2f2f2;
    color: #333;
  }

  .btnrow {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  button {
    padding: 7px 10px;
    cursor: pointer;
    border-radius: 8px;
    border: 1px solid #888;
    background: #f3f3f3;
    user-select: none;
  }
  button.fixed {
    background: #0078d4;
    color: white;
    border-color: #005a9e;
  }

  #fixed-info { font-size: 14px; margin-top: 8px; color: #333; }
  #message { margin-top: 6px; font-size: 13px; color: #c00; min-height: 1.2em; }
</style>
</head>

<body>
<h1>ğŸ“¦ ç´™å®¹å™¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</h1>
<div class="formula"> V = a(21 - 2b)b </div>

<div class="section">
  <h2>å…¥åŠ›ã‚¨ãƒªã‚¢</h2>
  <p style="margin-top:0;">
    ãƒ»å›ºå®šãŒ <strong>ON</strong> ã®ã¨ãï¼šãã®å¤‰æ•°ã‚’ä¸€å®šã«ä¿ã¡ã€ä»–ã‚’å¤‰ãˆã‚‹ã¨æ®‹ã‚ŠãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚<br>
    ãƒ»å›ºå®šãŒ <strong>ãªã—</strong> ã®ã¨ãï¼ša ã¨ b ã‹ã‚‰ V ã‚’å¸¸ã«è¨ˆç®—ã—ã¦è¡¨ç¤ºã—ã¾ã™ï¼ˆVã¯çµæœè¡¨ç¤ºï¼‰ã€‚
  </p>

  <table>
    <thead>
      <tr><th>å¤‰æ•°</th><th>å€¤</th></tr>
    </thead>
    <tbody>
      <tr>
        <th>aï¼ˆåº•é¢ã®æ¨ªï¼‰</th>
        <td><input id="input-a" type="number" step="0.001" min="0" /></td>
      </tr>
      <tr>
        <th>bï¼ˆé«˜ã•ï¼‰</th>
        <td><input id="input-b" type="number" step="0.001" min="0" /></td>
      </tr>
      <tr>
        <th>Vï¼ˆä½“ç©ï¼‰</th>
        <td><input id="input-v" type="number" step="0.001" min="0" /></td>
      </tr>
    </tbody>
  </table>

  <div class="btnrow">
    <button id="btn-fixed-none" type="button">å›ºå®šãªã—</button>
    <button id="btn-fixed-v" type="button">V å›ºå®šï¼šOFF</button>
    <button id="btn-fixed-a" type="button">a å›ºå®šï¼šOFF</button>
    <button id="btn-fixed-b" type="button">b å›ºå®šï¼šOFF</button>
    <button id="btn-graph" type="button">ã‚°ãƒ©ãƒ•</button>
    <button id="btn-save" type="button">ä¿å­˜ã™ã‚‹</button>
  </div>

  <div id="fixed-info"></div>
  <div id="message"></div>
</div>

<div class="section">
  <h2>ä¿å­˜ã•ã‚ŒãŸçµ„ã¿åˆã‚ã›</h2>
  <table id="saved-table">
    <thead>
      <tr><th>#</th><th>a</th><th>b</th><th>V</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== å®šæ•° =====
  const C = 21;
  const B_MAX = C / 2;   // b < 10.5
  const A_MAX = 8.7;     // ä»•æ§˜ä¸Šã®ä¸Šé™ï¼ˆå¿…è¦ãªã‚‰UIã§æ ¹æ‹ èª¬æ˜ï¼‰
  const EPS = 1e-6;

  // ===== DOM =====
  const inputA = document.getElementById('input-a');
  const inputB = document.getElementById('input-b');
  const inputV = document.getElementById('input-v');

  const btnNone = document.getElementById('btn-fixed-none');
  const btnV = document.getElementById('btn-fixed-v');
  const btnA = document.getElementById('btn-fixed-a');
  const btnB = document.getElementById('btn-fixed-b');
  const btnGraph = document.getElementById('btn-graph');
  const btnSave = document.getElementById('btn-save');

  const fixedInfo = document.getElementById('fixed-info');
  const message = document.getElementById('message');
  const savedTableBody = document.querySelector('#saved-table tbody');

  // ===== çŠ¶æ…‹ =====
  // fixedMode: null | 'V' | 'a' | 'b'
  // null ãŒã€Œå›ºå®šãªã—ã€ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›ºå®šãªã—ã€‚
  let fixedMode = null;
  let saveCount = 0;

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function setMessage(text) { message.textContent = text || ''; }
  function isFiniteNum(x) { return Number.isFinite(x); }
  function readNum(el) {
    const v = parseFloat(el.value);
    return Number.isFinite(v) ? v : NaN;
  }
  function fmt(x) { return Number.isFinite(x) ? x.toFixed(3) : ''; }

  // ===== æ•°å¼ =====
  function calcV(a, b) { return a * (C - 2 * b) * b; }

  // V=a(C-2b)b ã‹ã‚‰ã€aã¨VãŒä¸ãˆã‚‰ã‚ŒãŸã¨ãã® b
  function solveBFromAV(a, V) {
    if (!isFiniteNum(a) || a <= 0) return null;
    if (!isFiniteNum(V) || V < 0) return null;

    const D = (C * a) * (C * a) - 8 * a * V;
    if (D < 0) return null;

    const sqrtD = Math.sqrt(D);
    const b1 = (C * a + sqrtD) / (4 * a);
    const b2 = (C * a - sqrtD) / (4 * a);

    const candidates = [b1, b2].filter(b => isFiniteNum(b) && b > 0 + EPS && b < B_MAX - EPS);
    if (candidates.length === 0) return null;

    // æˆæ¥­çš„ã«ã€Œå°ã•ã„æ–¹ã€ã‚’æ¡ç”¨ï¼ˆå¿…è¦ãªã‚‰å¤‰æ›´å¯ï¼‰
    return Math.min(...candidates);
  }

  // b,Vã‹ã‚‰a
  function solveAFromBV(b, V) {
    if (!isFiniteNum(b) || b <= 0 || b >= B_MAX) return null;
    if (!isFiniteNum(V) || V < 0) return null;

    const denom = (C - 2 * b) * b;
    if (!(denom > 0)) return null;

    const a = V / denom;
    if (!isFiniteNum(a) || a <= 0) return null;
    return a;
  }

  function validateAB(a, b) {
    if (!isFiniteNum(a) || a <= 0) return 'a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    if (!isFiniteNum(b) || b <= 0) return 'b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    if (!(b < B_MAX)) return `b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`;
    if (a > A_MAX) return `a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`;
    return '';
  }

  // ===== å›ºå®šãƒˆã‚°ãƒ«ï¼ˆåŒæ™‚ONä¸å¯ï¼‰=====
  function setFixedNone() {
    fixedMode = null;
    updateFixedDisplay();
    setMessage('');
    reconcileAfterModeChange();
  }

  function toggleFixed(mode) {
    setMessage('');

    if (fixedMode === mode) {
      fixedMode = null;     // ONâ†’OFF
    } else {
      fixedMode = mode;     // OFFâ†’ONï¼ˆä»–ã¯è‡ªå‹•OFFæ‰±ã„ï¼‰
    }
    updateFixedDisplay();
    reconcileAfterModeChange();
  }

  function updateFixedDisplay() {
    const vOn = fixedMode === 'V';
    const aOn = fixedMode === 'a';
    const bOn = fixedMode === 'b';

    btnNone.classList.toggle('fixed', fixedMode === null);
    btnV.classList.toggle('fixed', vOn);
    btnA.classList.toggle('fixed', aOn);
    btnB.classList.toggle('fixed', bOn);

    btnV.textContent = `V å›ºå®šï¼š${vOn ? 'ON' : 'OFF'}`;
    btnA.textContent = `a å›ºå®šï¼š${aOn ? 'ON' : 'OFF'}`;
    btnB.textContent = `b å›ºå®šï¼š${bOn ? 'ON' : 'OFF'}`;

    const info =
      fixedMode === null ? 'ç¾åœ¨ï¼šå›ºå®šãªã—ï¼ˆa,bâ†’Vã‚’è¨ˆç®—ï¼‰' :
      fixedMode === 'V'  ? 'ç¾åœ¨ï¼šVå›ºå®šï¼ˆVã‚’ä¿ã£ã¦a,bã‚’èª¿æ•´ï¼‰' :
      fixedMode === 'a'  ? 'ç¾åœ¨ï¼šaå›ºå®šï¼ˆaã‚’ä¿ã£ã¦b,Vã‚’èª¿æ•´ï¼‰' :
                           'ç¾åœ¨ï¼šbå›ºå®šï¼ˆbã‚’ä¿ã£ã¦a,Vã‚’èª¿æ•´ï¼‰';
    fixedInfo.textContent = info;

    // å›ºå®šã•ã‚Œã¦ã„ã‚‹å¤‰æ•°ã¯ç·¨é›†ä¸å¯
    inputA.readOnly = (fixedMode === 'a');
    inputB.readOnly = (fixedMode === 'b');

    // å›ºå®šãªã—ã®æ™‚ã¯ V ã¯çµæœè¡¨ç¤ºå°‚ç”¨ã«ã™ã‚‹ï¼ˆUXæ”¹å–„ï¼‰
    inputV.readOnly = (fixedMode === null);
  }

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ç›´å¾Œã«æ•´åˆã‚’å–ã‚‹
  function reconcileAfterModeChange() {
    const a = readNum(inputA);
    const b = readNum(inputB);
    const V = readNum(inputV);

    try {
      if (fixedMode === null) {
        if (isFiniteNum(a) && isFiniteNum(b)) {
          const err = validateAB(a, b);
          if (err) throw new Error(err);
          inputV.value = fmt(calcV(a, b));
        } else {
          inputV.value = '';
        }
        return;
      }

      if (fixedMode === 'V') {
        // VãŒç„¡ã„ãªã‚‰ a,b ã‹ã‚‰ä½œã‚‹
        if (!isFiniteNum(V)) {
          if (isFiniteNum(a) && isFiniteNum(b)) {
            const err = validateAB(a, b);
            if (err) throw new Error(err);
            inputV.value = fmt(calcV(a, b));
          } else {
            throw new Error('Vå›ºå®šã‚’ONã«ã™ã‚‹ã«ã¯ã€V ã‹ a,b ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          }
        } else {
          // VãŒã‚ã‚‹ãªã‚‰ bå„ªå…ˆã§aè£œå®Œã€ãªã‘ã‚Œã°aå„ªå…ˆã§bè£œå®Œ
          if (isFiniteNum(b)) {
            const a2 = solveAFromBV(b, V);
            if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
            inputA.value = fmt(a2);
          } else if (isFiniteNum(a)) {
            const b2 = solveBFromAV(a, V);
            if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            inputB.value = fmt(b2);
          }
        }
        return;
      }

      if (fixedMode === 'a') {
        if (!isFiniteNum(a) || a <= 0) throw new Error('aå›ºå®šã‚’ONã«ã™ã‚‹ã«ã¯ a ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        if (a > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);

        if (isFiniteNum(b)) {
          const err = validateAB(a, b);
          if (err) throw new Error(err);
          inputV.value = fmt(calcV(a, b));
        } else if (isFiniteNum(V)) {
          const b2 = solveBFromAV(a, V);
          if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          inputB.value = fmt(b2);
        }
        return;
      }

      if (fixedMode === 'b') {
        if (!isFiniteNum(b) || b <= 0) throw new Error('bå›ºå®šã‚’ONã«ã™ã‚‹ã«ã¯ b ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        if (!(b < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);

        if (isFiniteNum(a)) {
          const err = validateAB(a, b);
          if (err) throw new Error(err);
          inputV.value = fmt(calcV(a, b));
        } else if (isFiniteNum(V)) {
          const a2 = solveAFromBV(b, V);
          if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
          inputA.value = fmt(a2);
        }
        return;
      }
    } catch (e) {
      setMessage(e.message || String(e));
    }
  }

  // ===== å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆæœ¬ä½“ =====
  function handleInput(changed) {
    setMessage('');

    const a = readNum(inputA);
    const b = readNum(inputB);
    const V = readNum(inputV);

    try {
      if (fixedMode === null) {
        // å›ºå®šãªã—ï¼ša,b -> Vï¼ˆVã¯readonlyï¼‰
        if (changed === 'a' || changed === 'b') {
          if (isFiniteNum(a) && isFiniteNum(b)) {
            const err = validateAB(a, b);
            if (err) throw new Error(err);
            inputV.value = fmt(calcV(a, b));
          } else {
            inputV.value = '';
          }
        }
        return;
      }

      if (fixedMode === 'V') {
        if (!isFiniteNum(V)) throw new Error('V ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆVå›ºå®šONï¼‰ã€‚');

        if (changed === 'a') {
          if (!isFiniteNum(a) || a <= 0) throw new Error('a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (a > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
          const b2 = solveBFromAV(a, V);
          if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          inputB.value = fmt(b2);
          return;
        }

        if (changed === 'b') {
          if (!isFiniteNum(b) || b <= 0) throw new Error('b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (!(b < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);
          const a2 = solveAFromBV(b, V);
          if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
          inputA.value = fmt(a2);
          return;
        }

        if (changed === 'V') {
          // Vã‚’å¤‰ãˆãŸã‚‰ã€å…¥åŠ›æ¸ˆã¿ã®æ–¹ã‚’åŸºæº–ã«è£œå®Œï¼ˆbå„ªå…ˆï¼‰
          if (isFiniteNum(b)) {
            const a2 = solveAFromBV(b, V);
            if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
            inputA.value = fmt(a2);
          } else if (isFiniteNum(a)) {
            const b2 = solveBFromAV(a, V);
            if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            inputB.value = fmt(b2);
          } else {
            throw new Error('Vå›ºå®šONã§ V ã‚’å¤‰ãˆã‚‹ã¨ãã¯ã€a ã¾ãŸã¯ b ã‚‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          }
          return;
        }
      }

      if (fixedMode === 'a') {
        if (!isFiniteNum(a) || a <= 0) throw new Error('a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆaå›ºå®šONï¼‰ã€‚');
        if (a > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);

        if (changed === 'b') {
          if (!isFiniteNum(b) || b <= 0) throw new Error('b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (!(b < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);
          inputV.value = fmt(calcV(a, b));
          return;
        }

        if (changed === 'V') {
          if (!isFiniteNum(V)) throw new Error('V ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          const b2 = solveBFromAV(a, V);
          if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          inputB.value = fmt(b2);
          return;
        }

        return;
      }

      if (fixedMode === 'b') {
        if (!isFiniteNum(b) || b <= 0) throw new Error('b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆbå›ºå®šONï¼‰ã€‚');
        if (!(b < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);

        if (changed === 'a') {
          if (!isFiniteNum(a) || a <= 0) throw new Error('a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (a > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
          inputV.value = fmt(calcV(a, b));
          return;
        }

        if (changed === 'V') {
          if (!isFiniteNum(V)) throw new Error('V ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          const a2 = solveAFromBV(b, V);
          if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
          inputA.value = fmt(a2);
          return;
        }

        return;
      }
    } catch (e) {
      setMessage(e.message || String(e));
    }
  }

  // ===== ä¿å­˜ =====
  function saveCurrent() {
    const a = readNum(inputA);
    const b = readNum(inputB);
    const V = readNum(inputV);

    if (![a, b, V].every(isFiniteNum)) {
      setMessage('a, b, V ã®æ•°å€¤ãŒæƒã£ã¦ã„ã¾ã›ã‚“ã€‚');
      return;
    }

    saveCount += 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${saveCount}</td>
      <td>${fmt(a)}</td>
      <td>${fmt(b)}</td>
      <td>${fmt(V)}</td>
    `;
    savedTableBody.appendChild(tr);
    setMessage('');
  }

  // ===== ã‚°ãƒ©ãƒ•ï¼ˆPlotlyï¼šåˆ¥ã‚¿ãƒ–ãƒ»ã‚ºãƒ¼ãƒ /ãƒ‘ãƒ³å¯ãƒ»2D/3Dåˆ‡æ›¿ï¼‰=====
  function openGraph() {
    setMessage('');

    const a = readNum(inputA);
    const b = readNum(inputB);
    const V = readNum(inputV);

    const w = window.open('', '_blank');
    if (!w) {
      setMessage('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // åˆ¥ã‚¿ãƒ–ã®HTMLéª¨æ ¼ï¼ˆPlotly CDNï¼‰
    const html = `
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚°ãƒ©ãƒ•</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; }
  #top { padding: 12px 14px; border-bottom: 1px solid #ddd; }
  #plot { width: 100vw; height: calc(100vh - 80px); }
  code { background:#f2f2f2; padding:2px 4px; border-radius:4px; }
  .small { margin-top:6px; color:#444; font-size:13px; }
</style>
</head>
<body>
  <div id="top">
    <div id="desc"></div>
    <div class="small">æ“ä½œï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³/å›è»¢ã€ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆå³ä¸Šã®ãƒ¢ãƒ¼ãƒ‰ãƒãƒ¼ã§ã‚‚æ“ä½œå¯ï¼‰</div>
  </div>
  <div id="plot"></div>

<script>
  const C = ${C};
  const B_MAX = ${B_MAX};
  const A_MAX = ${A_MAX};
  const EPS = ${EPS};

  function calcV(a, b){ return a * (C - 2*b) * b; }
</script>
</body>
</html>`;
    w.document.open();
    w.document.write(html);
    w.document.close();

    function inject(js) {
      const s = w.document.createElement('script');
      s.type = 'text/javascript';
      s.text = js;
      w.document.body.appendChild(s);
    }

    // fixedModeã«å¿œã˜ã¦2D/3D
    // 2Dã®è»¸ã¯ã€Œå›ºå®šå€¤ã«å¯¾ã™ã‚‹æ®‹ã‚Š2å¤‰æ•°ã®é–¢ä¿‚ã€ãŒåˆ†ã‹ã‚Šã‚„ã™ã„é¸ã³æ–¹ã«ã—ã¦ã„ã¾ã™ã€‚
    if (fixedMode === 'V') {
      if (!isFiniteNum(V)) { w.close(); setMessage('ã‚°ãƒ©ãƒ•ï¼šVå›ºå®šONã§ã¯ V ãŒå¿…è¦ã§ã™ã€‚'); return; }

      // Vå›ºå®šï¼š220 = a(21-2b)b â†’ a = V / ((21-2b)b)
      inject(`
        const V0 = ${isFiniteNum(V) ? V : 'NaN'};
        document.getElementById('desc').innerHTML =
          '2æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼š<code>V = ' + V0.toFixed(3) + '</code> å›ºå®šï¼ˆæ¨ªè»¸ï¼šbã€ç¸¦è»¸ï¼šaï¼‰<br>' +
          'å¼ï¼š<code>a = V / ((21-2b)b)</code>';

        const xs = [];
        const ys = [];
        const N = 1200;

        for (let i=0; i<N; i++){
          const b = (B_MAX - 2*EPS) * (i/(N-1)) + EPS;
          const denom = (C - 2*b) * b;
          if (!(denom > 0)) continue;
          const a = V0 / denom;
          if (!Number.isFinite(a)) continue;
          if (a > EPS && a <= A_MAX + 1e-9){
            xs.push(b);
            ys.push(a);
          }
        }

        const trace = { x: xs, y: ys, mode: 'lines', name: 'a(b)' };
        const layout = {
          margin: {l: 70, r: 20, t: 10, b: 60},
          xaxis: { title: 'bï¼ˆé«˜ã•ï¼‰' },
          yaxis: { title: 'aï¼ˆåº•é¢ã®æ¨ªï¼‰' },
          annotations: [{
            xref:'paper', yref:'paper', x:0, y:1.12, showarrow:false,
            text:'è»¸å¯¾å¿œï¼šx=bã€y=a'
          }]
        };
        Plotly.newPlot('plot', [trace], layout, {responsive:true});
      `);
      return;
    }

    if (fixedMode === 'a') {
      if (!isFiniteNum(a)) { w.close(); setMessage('ã‚°ãƒ©ãƒ•ï¼šaå›ºå®šONã§ã¯ a ãŒå¿…è¦ã§ã™ã€‚'); return; }

      // aå›ºå®šï¼šV = a(21-2b)b â†’ V(b)
      inject(`
        const a0 = ${isFiniteNum(a) ? a : 'NaN'};
        document.getElementById('desc').innerHTML =
          '2æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼š<code>a = ' + a0.toFixed(3) + '</code> å›ºå®šï¼ˆæ¨ªè»¸ï¼šbã€ç¸¦è»¸ï¼šVï¼‰<br>' +
          'å¼ï¼š<code>V = a(21-2b)b</code>';

        const xs = [];
        const ys = [];
        const N = 900;

        for (let i=0; i<N; i++){
          const b = (B_MAX - 2*EPS) * (i/(N-1)) + EPS;
          const V = calcV(a0, b);
          if (Number.isFinite(V)) { xs.push(b); ys.push(V); }
        }

        const trace = { x: xs, y: ys, mode: 'lines', name: 'V(b)' };
        const layout = {
          margin: {l: 70, r: 20, t: 10, b: 60},
          xaxis: { title: 'bï¼ˆé«˜ã•ï¼‰' },
          yaxis: { title: 'Vï¼ˆä½“ç©ï¼‰' },
          annotations: [{
            xref:'paper', yref:'paper', x:0, y:1.12, showarrow:false,
            text:'è»¸å¯¾å¿œï¼šx=bã€y=V'
          }]
        };
        Plotly.newPlot('plot', [trace], layout, {responsive:true});
      `);
      return;
    }

    if (fixedMode === 'b') {
      if (!isFiniteNum(b)) { w.close(); setMessage('ã‚°ãƒ©ãƒ•ï¼šbå›ºå®šONã§ã¯ b ãŒå¿…è¦ã§ã™ã€‚'); return; }

      // bå›ºå®šï¼šV = a(21-2b)b â†’ V(a)
      inject(`
        const b0 = ${isFiniteNum(b) ? b : 'NaN'};
        document.getElementById('desc').innerHTML =
          '2æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼š<code>b = ' + b0.toFixed(3) + '</code> å›ºå®šï¼ˆæ¨ªè»¸ï¼šaã€ç¸¦è»¸ï¼šVï¼‰<br>' +
          'å¼ï¼š<code>V = a(21-2b)b</code>';

        const xs = [];
        const ys = [];
        const N = 700;

        for (let i=0; i<N; i++){
          const a = (A_MAX - 2*EPS) * (i/(N-1)) + EPS;
          const V = calcV(a, b0);
          if (Number.isFinite(V)) { xs.push(a); ys.push(V); }
        }

        const trace = { x: xs, y: ys, mode: 'lines', name: 'V(a)' };
        const layout = {
          margin: {l: 70, r: 20, t: 10, b: 60},
          xaxis: { title: 'aï¼ˆåº•é¢ã®æ¨ªï¼‰' },
          yaxis: { title: 'Vï¼ˆä½“ç©ï¼‰' },
          annotations: [{
            xref:'paper', yref:'paper', x:0, y:1.12, showarrow:false,
            text:'è»¸å¯¾å¿œï¼šx=aã€y=V'
          }]
        };
        Plotly.newPlot('plot', [trace], layout, {responsive:true});
      `);
      return;
    }

    // å›ºå®šãªã— â†’ 3Dï¼ˆx=b, y=a, z=V ã®æ›²é¢ï¼‰
    inject(`
      document.getElementById('desc').innerHTML =
        '3æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼šå›ºå®šãªã—ï¼ˆæ›²é¢ <code>V = a(21-2b)b</code>ï¼‰<br>' +
        'è»¸å¯¾å¿œï¼šx=bã€y=aã€z=V';

      const nA = 60;
      const nB = 60;
      const x = []; // b
      const y = []; // a
      const z = []; // V

      for (let i=0; i<nB; i++){
        x.push((B_MAX - 2*EPS) * (i/(nB-1)) + EPS);
      }
      for (let j=0; j<nA; j++){
        y.push((A_MAX - 2*EPS) * (j/(nA-1)) + EPS);
      }

      for (let j=0; j<nA; j++){
        const row = [];
        for (let i=0; i<nB; i++){
          row.push(calcV(y[j], x[i])); // a=y[j], b=x[i]
        }
        z.push(row);
      }

      const surface = { type:'surface', x:x, y:y, z:z, name:'V(a,b)' };
      const layout = {
        margin:{l:0,r:0,t:0,b:0},
        scene:{
          xaxis:{title:'bï¼ˆé«˜ã•ï¼‰'},
          yaxis:{title:'aï¼ˆåº•é¢ã®æ¨ªï¼‰'},
          zaxis:{title:'Vï¼ˆä½“ç©ï¼‰'}
        }
      };
      Plotly.newPlot('plot', [surface], layout, {responsive:true});
    `);
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² =====
  inputA.addEventListener('input', () => handleInput('a'));
  inputB.addEventListener('input', () => handleInput('b'));
  inputV.addEventListener('input', () => handleInput('V'));

  btnNone.addEventListener('click', setFixedNone);
  btnV.addEventListener('click', () => toggleFixed('V'));
  btnA.addEventListener('click', () => toggleFixed('a'));
  btnB.addEventListener('click', () => toggleFixed('b'));

  btnGraph.addEventListener('click', openGraph);
  btnSave.addEventListener('click', saveCurrent);

  // ===== åˆæœŸåŒ– =====
  function init() {
    // åˆæœŸå€¤ï¼ˆä¾‹ï¼‰ï¼ša=4, b=5 â†’ V=220
    const a0 = 4.0;
    const b0 = 5.0;
    inputA.value = fmt(a0);
    inputB.value = fmt(b0);

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›ºå®šãªã—
    fixedMode = null;
    updateFixedDisplay();
    setMessage('');

    // Vè¨ˆç®—
    handleInput('a');
  }

  init();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç´™å®¹å™¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    padding: 20px;
    max-width: 980px;
    margin: auto;
  }
  h1 { font-size: 22px; margin-bottom: 8px; }
  .formula {
    font-family: "Cambria Math", "Times New Roman", serif;
    font-size: 28px;
    margin-bottom: 16px;
  }
  .section {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 20px;
  }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
  th { background-color: #f5f5f5; }
  input[type="number"] {
    width: 100%;
    box-sizing: border-box;
    padding: 4px 6px;
    text-align: right;
  }
  input[readonly] {
    background: #f2f2f2;
    color: #333;
  }
  .btnrow {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  button {
    padding: 7px 10px;
    cursor: pointer;
    border-radius: 8px;
    border: 1px solid #888;
    background: #f3f3f3;
    user-select: none;
  }
  button.fixed {
    background: #0078d4;
    color: white;
    border-color: #005a9e;
  }
  #fixed-info { font-size: 14px; margin-top: 8px; color: #333; }
  #message { margin-top: 6px; font-size: 13px; color: #c00; min-height: 1.2em; }
</style>
</head>

<body>
<h1>ğŸ“¦ ç´™å®¹å™¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</h1>
<div class="formula"> V = a(21 - 2b)b </div>

<div class="section">
  <h2>å…¥åŠ›ã‚¨ãƒªã‚¢</h2>
  <p style="margin-top:0;">
    ãƒ»å›ºå®šãŒ <strong>ON</strong> ã®ã¨ãï¼šãã®å¤‰æ•°ã‚’ä¸€å®šã«ä¿ã¡ã€ä»–ã‚’å¤‰ãˆã‚‹ã¨æ®‹ã‚ŠãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚<br>
    ãƒ»å›ºå®šãŒ <strong>ãªã—</strong> ã®ã¨ãï¼ša ã¨ b ã‹ã‚‰ V ã‚’å¸¸ã«è¨ˆç®—ã—ã¦è¡¨ç¤ºã—ã¾ã™ï¼ˆV ã¯çµæœè¡¨ç¤ºå°‚ç”¨ï¼‰ã€‚
  </p>

  <table>
    <thead>
      <tr>
        <th>å¤‰æ•°</th>
        <th>å€¤</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>aï¼ˆåº•é¢ã®æ¨ªï¼‰</th>
        <td><input id="input-a" type="number" step="0.001" min="0" /></td>
      </tr>
      <tr>
        <th>bï¼ˆé«˜ã•ï¼‰</th>
        <td><input id="input-b" type="number" step="0.001" min="0" /></td>
      </tr>
      <tr>
        <th>Vï¼ˆä½“ç©ï¼‰</th>
        <td><input id="input-v" type="number" step="0.001" min="0" /></td>
      </tr>
    </tbody>
  </table>

  <div class="btnrow">
    <button id="btn-fixed-none">å›ºå®šãªã—</button>
    <button id="btn-fixed-v">V å›ºå®š</button>
    <button id="btn-fixed-a">a å›ºå®š</button>
    <button id="btn-fixed-b">b å›ºå®š</button>
    <button id="btn-graph">ã‚°ãƒ©ãƒ•</button>
    <button id="btn-save">ä¿å­˜ã™ã‚‹</button>
  </div>

  <div id="fixed-info"></div>
  <div id="message"></div>
</div>

<div class="section">
  <h2>ä¿å­˜ã•ã‚ŒãŸçµ„ã¿åˆã‚ã›</h2>
  <table id="saved-table">
    <thead>
      <tr>
        <th>#</th>
        <th>a</th>
        <th>b</th>
        <th>V</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // ===== å®šæ•°ï¼ˆæˆæ¥­æ–‡è„ˆã§å¿…è¦ãªã‚‰èª¬æ˜æ–‡ã‚‚è¿½åŠ ã—ã¦OKï¼‰ =====
  const C = 21;            // V = a(C - 2b)b
  const B_MAX = C / 2;     // (C - 2b) > 0 ã®ä¸Šé™ -> b < 10.5
  const A_MAX = 8.7;       // åˆ¶ç´„ï¼ˆç´™ã®ã‚µã‚¤ã‚ºç­‰ã‹ã‚‰æ¥ã¦ã„ã‚‹æƒ³å®šï¼‰
  const EPS = 1e-6;

  // ===== DOM =====
  const inputA = document.getElementById('input-a');
  const inputB = document.getElementById('input-b');
  const inputV = document.getElementById('input-v');

  const btnNone = document.getElementById('btn-fixed-none');
  const btnV = document.getElementById('btn-fixed-v');
  const btnA = document.getElementById('btn-fixed-a');
  const btnB = document.getElementById('btn-fixed-b');
  const btnGraph = document.getElementById('btn-graph');
  const btnSave = document.getElementById('btn-save');

  const fixedInfo = document.getElementById('fixed-info');
  const message = document.getElementById('message');
  const savedTableBody = document.querySelector('#saved-table tbody');

  // ===== çŠ¶æ…‹ =====
  // fixedMode: 'none' | 'V' | 'a' | 'b' ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›ºå®šãªã—ï¼‰
  let fixedMode = 'none';
  let saveCount = 0;

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function setMessage(text) {
    message.textContent = text || '';
  }
  function isFiniteNum(x) {
    return Number.isFinite(x);
  }
  function readNum(inputEl) {
    const v = parseFloat(inputEl.value);
    return Number.isFinite(v) ? v : NaN;
  }
  function fmt(x) {
    return Number.isFinite(x) ? x.toFixed(3) : '';
  }

  // ===== æ•°å¼ =====
  function calcV(a, b) {
    return a * (C - 2 * b) * b;
  }

  // V=a(C-2b)b ã‹ã‚‰ã€aã¨VãŒä¸ãˆã‚‰ã‚ŒãŸã¨ãã® b ã‚’è§£ãï¼ˆäºŒæ¬¡æ–¹ç¨‹å¼ï¼‰
  function solveBFromAV(a, V) {
    if (!isFiniteNum(a) || a <= 0) return null;
    if (!isFiniteNum(V) || V < 0) return null;

    // 2ab^2 - Cab + V = 0
    // D = (Ca)^2 - 8aV
    const D = (C * a) * (C * a) - 8 * a * V;
    if (D < 0) return null;

    const sqrtD = Math.sqrt(D);
    const b1 = (C * a + sqrtD) / (4 * a);
    const b2 = (C * a - sqrtD) / (4 * a);

    const candidates = [b1, b2].filter(b => isFiniteNum(b) && b > 0 + EPS && b < B_MAX - EPS);
    if (candidates.length === 0) return null;

    // æˆæ¥­çš„ã«ã€Œå°ã•ã„æ–¹ã€ã‚’é¸ã¶ï¼ˆå¿…è¦ãªã‚‰ãƒ«ãƒ¼ãƒ«ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ï¼‰
    return Math.min(...candidates);
  }

  // bå›ºå®šãƒ»Vå›ºå®šã®ã¨ã a ã‚’æ±‚ã‚ã‚‹
  function solveAFromBV(b, V) {
    if (!isFiniteNum(b) || b <= 0 || b >= B_MAX) return null;
    if (!isFiniteNum(V) || V < 0) return null;
    const denom = (C - 2 * b) * b;
    if (!(denom > 0)) return null;
    const a = V / denom;
    if (!isFiniteNum(a) || a <= 0) return null;
    return a;
  }

  // a,b ãŒç‰©ç†/è¨­å®šä¸Šå¦¥å½“ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…è¦ãªã‚‰ç·©ã‚ã¦OKï¼‰
  function validateAB(a, b) {
    if (!isFiniteNum(a) || a <= 0) return 'a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    if (!isFiniteNum(b) || b <= 0) return 'b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    if (!(b < B_MAX)) return `b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ï¼ˆ(21-2b)>0ï¼‰ã€‚`;
    if (a > A_MAX) return `a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`;
    return '';
  }

  // ===== UIï¼ˆå›ºå®šçŠ¶æ…‹ã®è¡¨ç¤º & å…¥åŠ›ãƒ­ãƒƒã‚¯ï¼‰ =====
  function updateFixedDisplay() {
    btnNone.classList.toggle('fixed', fixedMode === 'none');
    btnV.classList.toggle('fixed', fixedMode === 'V');
    btnA.classList.toggle('fixed', fixedMode === 'a');
    btnB.classList.toggle('fixed', fixedMode === 'b');

    const msg =
      fixedMode === 'none' ? 'ç¾åœ¨ï¼šå›ºå®šãªã—ï¼ˆa,bâ†’Vã‚’è¨ˆç®—ï¼‰' :
      fixedMode === 'V'    ? 'ç¾åœ¨ï¼šVå›ºå®šï¼ˆVã‚’ä¿ã£ã¦a,bã‚’èª¿æ•´ï¼‰' :
      fixedMode === 'a'    ? 'ç¾åœ¨ï¼šaå›ºå®šï¼ˆaã‚’ä¿ã£ã¦b,Vã‚’èª¿æ•´ï¼‰' :
                             'ç¾åœ¨ï¼šbå›ºå®šï¼ˆbã‚’ä¿ã£ã¦a,Vã‚’èª¿æ•´ï¼‰';
    fixedInfo.textContent = msg;

    // readonlyåˆ¶å¾¡
    inputA.readOnly = (fixedMode === 'a');
    inputB.readOnly = (fixedMode === 'b');
    inputV.readOnly = (fixedMode === 'none'); // å›ºå®šãªã—ã§ã¯ V ã¯è¨ˆç®—çµæœè¡¨ç¤ºå°‚ç”¨
  }

  function setFixedMode(mode) {
    fixedMode = mode; // ã“ã‚Œã§ã€ŒåŒæ™‚ONä¸å¯ã€è¦ä»¶ã‚’æº€ãŸã™ï¼ˆå¸¸ã«1ã¤ã ã‘ï¼‰
    updateFixedDisplay();
    setMessage('');

    // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ç›´å¾Œã«æ•´åˆã•ã›ã‚‹
    // - none: a,bãŒæƒã£ã¦ã„ãŸã‚‰Vå†è¨ˆç®—
    // - å›ºå®š: ã™ã§ã«å€¤ãŒæƒã£ã¦ã„ã‚Œã°çŸ›ç›¾ãŒãªã„ã‚ˆã†ã«V/æ®‹ã‚Šã‚’è¨ˆç®—ï¼ˆã§ãã‚‹ç¯„å›²ã§ï¼‰
    reconcileAfterModeChange();
  }

  function reconcileAfterModeChange() {
    const a = readNum(inputA);
    const b = readNum(inputB);
    const V = readNum(inputV);

    try {
      if (fixedMode === 'none') {
        if (isFiniteNum(a) && isFiniteNum(b)) {
          const err = validateAB(a, b);
          if (err) throw new Error(err);
          inputV.value = fmt(calcV(a, b));
        } else {
          // æ¬ ã‘ã¦ã„ã‚Œã°Vã¯ç©ºã«
          inputV.value = '';
        }
        return;
      }

      if (fixedMode === 'V') {
        // Vå›ºå®šã«ã—ãŸãªã‚‰ã€VãŒç„¡ã„å ´åˆã¯ a,bã‹ã‚‰ä½œã‚‹
        if (!isFiniteNum(V)) {
          if (isFiniteNum(a) && isFiniteNum(b)) {
            const err = validateAB(a, b);
            if (err) throw new Error(err);
            inputV.value = fmt(calcV(a, b));
          } else {
            throw new Error('Vå›ºå®šã«ã™ã‚‹ã«ã¯ã€V ã‹ a,b ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          }
        } else {
          // VãŒã‚ã‚‹ãªã‚‰ã€a,bã®ã†ã¡æƒã£ã¦ã„ã‚‹æ–¹ã§æ•´åˆã•ã›ã‚‹ï¼ˆå„ªå…ˆï¼šbâ†’aã€ãªã‘ã‚Œã°aâ†’bï¼‰
          if (isFiniteNum(b)) {
            const a2 = solveAFromBV(b, V);
            if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
            inputA.value = fmt(a2);
          } else if (isFiniteNum(a)) {
            const b2 = solveBFromAV(a, V);
            if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            inputB.value = fmt(b2);
          }
        }
        return;
      }

      if (fixedMode === 'a') {
        // aå›ºå®šï¼šaå¿…é ˆã€‚VãŒç„¡ã‘ã‚Œã° a,bã‹ã‚‰ä½œã‚‹ã€‚VãŒã‚ã‚Œã° a,Vã‹ã‚‰bã‚’ä½œã‚‹ã€‚
        if (!isFiniteNum(a) || a <= 0) throw new Error('aå›ºå®šã«ã™ã‚‹ã«ã¯ a ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        if (a > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
        if (isFiniteNum(V) && !isFiniteNum(b)) {
          const b2 = solveBFromAV(a, V);
          if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          inputB.value = fmt(b2);
        } else if (isFiniteNum(b)) {
          const err = validateAB(a, b);
          if (err) throw new Error(err);
          inputV.value = fmt(calcV(a, b));
        }
        return;
      }

      if (fixedMode === 'b') {
        // bå›ºå®šï¼šbå¿…é ˆã€‚VãŒç„¡ã‘ã‚Œã° a,bã‹ã‚‰ä½œã‚‹ã€‚VãŒã‚ã‚Œã° b,Vã‹ã‚‰aã‚’ä½œã‚‹ã€‚
        if (!isFiniteNum(b) || b <= 0) throw new Error('bå›ºå®šã«ã™ã‚‹ã«ã¯ b ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        if (!(b < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);
        if (isFiniteNum(V) && !isFiniteNum(a)) {
          const a2 = solveAFromBV(b, V);
          if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
          inputA.value = fmt(a2);
        } else if (isFiniteNum(a)) {
          const err = validateAB(a, b);
          if (err) throw new Error(err);
          inputV.value = fmt(calcV(a, b));
        }
        return;
      }
    } catch (e) {
      setMessage(e.message || String(e));
    }
  }

  // ===== å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã®æœ¬ä½“ =====
  function handleInput(changed) {
    setMessage('');

    const aVal = readNum(inputA);
    const bVal = readNum(inputB);
    const vVal = readNum(inputV);

    try {
      if (fixedMode === 'none') {
        // a,b â†’ Vï¼ˆVã¯è¡¨ç¤ºå°‚ç”¨ï¼‰
        if (changed === 'a' || changed === 'b') {
          if (isFiniteNum(aVal) && isFiniteNum(bVal)) {
            const err = validateAB(aVal, bVal);
            if (err) throw new Error(err);
            inputV.value = fmt(calcV(aVal, bVal));
          } else {
            inputV.value = '';
          }
        }
        // Vã‚’è§¦ã£ã¦ã‚‚readonlyã®ã¯ãšã ãŒå¿µã®ãŸã‚ç„¡è¦–
        return;
      }

      if (fixedMode === 'V') {
        // Vå›ºå®šï¼šVã‚’ä¿ã£ã¦èª¿æ•´
        if (!isFiniteNum(vVal)) throw new Error('V ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆVå›ºå®šï¼‰ã€‚');

        if (changed === 'a') {
          if (!isFiniteNum(aVal) || aVal <= 0) throw new Error('a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (aVal > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
          const b2 = solveBFromAV(aVal, vVal);
          if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          inputB.value = fmt(b2);
          return;
        }

        if (changed === 'b') {
          if (!isFiniteNum(bVal) || bVal <= 0) throw new Error('b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (!(bVal < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);
          const a2 = solveAFromBV(bVal, vVal);
          if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
          inputA.value = fmt(a2);
          return;
        }

        if (changed === 'V') {
          // Vã‚’å¤‰ãˆãŸã‚‰ã€Œæ–°ã—ã„å›ºå®šå€¤ã€ã«ãªã‚‹ã€‚
          // å„ªå…ˆï¼šbãŒå…¥ã£ã¦ã„ã‚Œã° bå›ºå®šã§aã‚’èª¿æ•´ã€ãªã‘ã‚Œã° aãŒå…¥ã£ã¦ã„ã‚Œã° aå›ºå®šã§bã‚’èª¿æ•´
          if (isFiniteNum(bVal)) {
            const a2 = solveAFromBV(bVal, vVal);
            if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
            inputA.value = fmt(a2);
          } else if (isFiniteNum(aVal)) {
            const b2 = solveBFromAV(aVal, vVal);
            if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
            inputB.value = fmt(b2);
          } else {
            throw new Error('V ã‚’å¤‰ãˆã‚‹ã«ã¯ã€a ã¾ãŸã¯ b ã®å€¤ã‚‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          }
          return;
        }
      }

      if (fixedMode === 'a') {
        // aå›ºå®šï¼šaä¸€å®šã€b<->V ã‚’èª¿æ•´
        if (!isFiniteNum(aVal) || aVal <= 0) throw new Error('a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆaå›ºå®šï¼‰ã€‚');
        if (aVal > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);

        if (changed === 'b') {
          if (!isFiniteNum(bVal) || bVal <= 0) throw new Error('b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (!(bVal < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);
          inputV.value = fmt(calcV(aVal, bVal));
          return;
        }

        if (changed === 'V') {
          if (!isFiniteNum(vVal)) throw new Error('V ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          const b2 = solveBFromAV(aVal, vVal);
          if (b2 === null) throw new Error('ãã® a ã¨ V ã®çµ„ã§ã¯ b ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          inputB.value = fmt(b2);
          return;
        }

        // aæ¬„ã¯readonlyã ãŒå¿µã®ãŸã‚
        if (changed === 'a') return;
      }

      if (fixedMode === 'b') {
        // bå›ºå®šï¼šbä¸€å®šã€a<->V ã‚’èª¿æ•´
        if (!isFiniteNum(bVal) || bVal <= 0) throw new Error('b ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆbå›ºå®šï¼‰ã€‚');
        if (!(bVal < B_MAX)) throw new Error(`b ã¯ ${B_MAX.toFixed(3)} æœªæº€ã«ã—ã¦ãã ã•ã„ã€‚`);

        if (changed === 'a') {
          if (!isFiniteNum(aVal) || aVal <= 0) throw new Error('a ã‚’æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          if (aVal > A_MAX) throw new Error(`a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
          inputV.value = fmt(calcV(aVal, bVal));
          return;
        }

        if (changed === 'V') {
          if (!isFiniteNum(vVal)) throw new Error('V ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          const a2 = solveAFromBV(bVal, vVal);
          if (a2 === null) throw new Error('ãã® b ã¨ V ã®çµ„ã§ã¯ a ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚');
          if (a2 > A_MAX) throw new Error(`è¨ˆç®—ã•ã‚ŒãŸ a ãŒä¸Šé™ï¼ˆ${A_MAX}ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
          inputA.value = fmt(a2);
          return;
        }

        // bæ¬„ã¯readonlyã ãŒå¿µã®ãŸã‚
        if (changed === 'b') return;
      }
    } catch (e) {
      setMessage(e.message || String(e));
    }
  }

  // ===== ä¿å­˜ =====
  function saveCurrent() {
    const aVal = readNum(inputA);
    const bVal = readNum(inputB);
    const vVal = readNum(inputV);

    if (![aVal, bVal, vVal].every(isFiniteNum)) {
      setMessage('a, b, V ã®æ•°å€¤ãŒæƒã£ã¦ã„ã¾ã›ã‚“ã€‚');
      return;
    }

    saveCount += 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${saveCount}</td>
      <td>${fmt(aVal)}</td>
      <td>${fmt(bVal)}</td>
      <td>${fmt(vVal)}</td>
    `;
    savedTableBody.appendChild(tr);
    setMessage('');
  }

  // ===== ã‚°ãƒ©ãƒ•ï¼ˆåˆ¥ã‚¿ãƒ– / ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³å¯ï¼‰ =====
  function openGraph() {
    setMessage('');

    const aVal = readNum(inputA);
    const bVal = readNum(inputB);
    const vVal = readNum(inputV);

    // æ–°è¦ã‚¿ãƒ–
    const w = window.open('', '_blank');
    if (!w) {
      setMessage('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // Plotlyã§ã‚ºãƒ¼ãƒ /ãƒ‘ãƒ³ï¼šæ¨™æº–ã§å¯èƒ½ï¼ˆãƒ¢ãƒ¼ãƒ‰ãƒãƒ¼ã‚ã‚Šï¼‰
    // 3D: surfaceã€2D: scatter line
    const baseHtml = `
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚°ãƒ©ãƒ•</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; }
  #top { padding: 12px 14px; border-bottom: 1px solid #ddd; }
  #plot { width: 100vw; height: calc(100vh - 64px); }
  code { background:#f2f2f2; padding:2px 4px; border-radius:4px; }
</style>
</head>
<body>
  <div id="top">
    <div id="desc"></div>
    <div style="margin-top:6px; color:#444; font-size:13px;">
      æ“ä½œï¼šãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢/ãƒ‘ãƒ³ã€ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆå³ä¸Šã®ãƒ¢ãƒ¼ãƒ‰ãƒãƒ¼ã§ã‚‚æ“ä½œå¯èƒ½ï¼‰
    </div>
  </div>
  <div id="plot"></div>

<script>
  const C = ${C};
  const B_MAX = ${B_MAX};
  const A_MAX = ${A_MAX};
  const EPS = ${EPS};

  function calcV(a, b){ return a * (C - 2*b) * b; }

  // 2D/3Dæç”»ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã®ã‚ã¨æ³¨å…¥
</script>
</body>
</html>
    `;

    w.document.open();
    w.document.write(baseHtml);
    w.document.close();

    // æç”»ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ³¨å…¥ï¼ˆfixedModeã«å¿œã˜ã¦ï¼‰
    const inject = (js) => {
      const s = w.document.createElement('script');
      s.type = 'text/javascript';
      s.text = js;
      w.document.body.appendChild(s);
    };

    // ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ç¯„å›²
    // b: (0, 10.5)ã€a: (0, 8.7) ã‚’åŸºæœ¬ã«ã—ã¦ã€æ›²ç·šã§ã¯æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹
    if (fixedMode === 'V') {
      if (!isFiniteNum(vVal)) {
        setMessage('ã‚°ãƒ©ãƒ•ï¼šVå›ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã¯ V ã®å€¤ãŒå¿…è¦ã§ã™ã€‚');
        w.close();
        return;
      }
      // 2D: Vå›ºå®š -> a = V / ((C-2b)b)  ï¼ˆæ¨ªè»¸ b, ç¸¦è»¸ aï¼‰
      const js = `
        const V0 = ${Number.isFinite(vVal) ? vVal : 'NaN'};
        document.getElementById('desc').innerHTML =
          '2æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼š<code>V = ' + V0.toFixed(3) + '</code> å›ºå®šã®ã¨ãã®é–¢ä¿‚ï¼ˆæ¨ªè»¸ï¼šbã€ç¸¦è»¸ï¼šaï¼‰';

        const xs = [];
        const ys = [];
        const N = 1200;
        for (let i=0; i<N; i++){
          const b = (B_MAX - 2*EPS) * (i/(N-1)) + EPS;
          const denom = (C - 2*b) * b;
          if (!(denom > 0)) continue;
          const a = V0 / denom;
          if (!Number.isFinite(a)) continue;
          if (a > EPS && a <= A_MAX + 1e-9) {
            xs.push(b);
            ys.push(a);
          }
        }

        const trace = { x: xs, y: ys, mode: 'lines', name: 'a(b)' };
        const layout = {
          margin: {l: 60, r: 20, t: 20, b: 60},
          xaxis: { title: 'bï¼ˆé«˜ã•ï¼‰' },
          yaxis: { title: 'aï¼ˆåº•é¢ã®æ¨ªï¼‰' },
          annotations: [{
            xref: 'paper', yref: 'paper', x: 0, y: 1.08, showarrow: false,
            text: 'è»¸å¯¾å¿œï¼šx=bã€y=a'
          }]
        };
        Plotly.newPlot('plot', [trace], layout, {responsive: true});
      `;
      inject(js);
      return;
    }

    if (fixedMode === 'a') {
      if (!isFiniteNum(aVal)) {
        setMessage('ã‚°ãƒ©ãƒ•ï¼šaå›ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã¯ a ã®å€¤ãŒå¿…è¦ã§ã™ã€‚');
        w.close();
        return;
      }
      // 2D: aå›ºå®š -> V = a(C-2b)b ï¼ˆæ¨ªè»¸ b, ç¸¦è»¸ Vï¼‰
      const js = `
        const a0 = ${Number.isFinite(aVal) ? aVal : 'NaN'};
        document.getElementById('desc').innerHTML =
          '2æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼š<code>a = ' + a0.toFixed(3) + '</code> å›ºå®šã®ã¨ãã®é–¢ä¿‚ï¼ˆæ¨ªè»¸ï¼šbã€ç¸¦è»¸ï¼šVï¼‰';

        const xs = [];
        const ys = [];
        const N = 800;
        for (let i=0; i<N; i++){
          const b = (B_MAX - 2*EPS) * (i/(N-1)) + EPS;
          const V = calcV(a0, b);
          if (Number.isFinite(V)) { xs.push(b); ys.push(V); }
        }

        const trace = { x: xs, y: ys, mode: 'lines', name: 'V(b)' };
        const layout = {
          margin: {l: 70, r: 20, t: 20, b: 60},
          xaxis: { title: 'bï¼ˆé«˜ã•ï¼‰' },
          yaxis: { title: 'Vï¼ˆä½“ç©ï¼‰' },
          annotations: [{
            xref: 'paper', yref: 'paper', x: 0, y: 1.08, showarrow: false,
            text: 'è»¸å¯¾å¿œï¼šx=bã€y=V'
          }]
        };
        Plotly.newPlot('plot', [trace], layout, {responsive: true});
      `;
      inject(js);
      return;
    }

    if (fixedMode === 'b') {
      if (!isFiniteNum(bVal)) {
        setMessage('ã‚°ãƒ©ãƒ•ï¼šbå›ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã¯ b ã®å€¤ãŒå¿…è¦ã§ã™ã€‚');
        w.close();
        return;
      }
      // 2D: bå›ºå®š -> V = a(C-2b)b ï¼ˆæ¨ªè»¸ a, ç¸¦è»¸ Vï¼‰
      const js = `
        const b0 = ${Number.isFinite(bVal) ? bVal : 'NaN'};
        document.getElementById('desc').innerHTML =
          '2æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼š<code>b = ' + b0.toFixed(3) + '</code> å›ºå®šã®ã¨ãã®é–¢ä¿‚ï¼ˆæ¨ªè»¸ï¼šaã€ç¸¦è»¸ï¼šVï¼‰';

        const xs = [];
        const ys = [];
        const N = 600;
        for (let i=0; i<N; i++){
          const a = (A_MAX - 2*EPS) * (i/(N-1)) + EPS;
          const V = calcV(a, b0);
          if (Number.isFinite(V)) { xs.push(a); ys.push(V); }
        }

        const trace = { x: xs, y: ys, mode: 'lines', name: 'V(a)' };
        const layout = {
          margin: {l: 70, r: 20, t: 20, b: 60},
          xaxis: { title: 'aï¼ˆåº•é¢ã®æ¨ªï¼‰' },
          yaxis: { title: 'Vï¼ˆä½“ç©ï¼‰' },
          annotations: [{
            xref: 'paper', yref: 'paper', x: 0, y: 1.08, showarrow: false,
            text: 'è»¸å¯¾å¿œï¼šx=aã€y=V'
          }]
        };
        Plotly.newPlot('plot', [trace], layout, {responsive: true});
      `;
      inject(js);
      return;
    }

    // fixedMode === 'none'
    // 3D: (a, b) -> V ã®æ›²é¢ï¼ˆx=b, y=a, z=Vï¼‰
    const js3d = `
      document.getElementById('desc').innerHTML =
        '3æ¬¡å…ƒã‚°ãƒ©ãƒ•ï¼šå›ºå®šãªã—ï¼ˆæ›²é¢ <code>V = a(21 - 2b)b</code>ï¼‰<br>' +
        'è»¸å¯¾å¿œï¼šx=bã€y=aã€z=V';

      const nA = 60;
      const nB = 60;

      // x: b, y: a, z: V
      const x = [];
      const y = [];
      const z = [];

      for (let i=0; i<nB; i++){
        const b = (B_MAX - 2*EPS) * (i/(nB-1)) + EPS;
        x.push(b);
      }
      for (let j=0; j<nA; j++){
        const a = (A_MAX - 2*EPS) * (j/(nA-1)) + EPS;
        y.push(a);
      }

      for (let j=0; j<nA; j++){
        const row = [];
        for (let i=0; i<nB; i++){
          row.push(calcV(y[j], x[i]));
        }
        z.push(row);
      }

      const surface = {
        type: 'surface',
        x: x,   // b
        y: y,   // a
        z: z,   // V
        name: 'V(a,b)'
      };

      const layout = {
        margin: {l: 0, r: 0, t: 0, b: 0},
        scene: {
          xaxis: { title: 'bï¼ˆé«˜ã•ï¼‰' },
          yaxis: { title: 'aï¼ˆåº•é¢ã®æ¨ªï¼‰' },
          zaxis: { title: 'Vï¼ˆä½“ç©ï¼‰' }
        }
      };

      Plotly.newPlot('plot', [surface], layout, {responsive: true});
    `;
    inject(js3d);
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² =====
  inputA.addEventListener('input', () => handleInput('a'));
  inputB.addEventListener('input', () => handleInput('b'));
  inputV.addEventListener('input', () => handleInput('V'));

  btnNone.addEventListener('click', () => setFixedMode('none'));
  btnV.addEventListener('click', () => setFixedMode('V'));
  btnA.addEventListener('click', () => setFixedMode('a'));
  btnB.addEventListener('click', () => setFixedMode('b'));

  btnGraph.addEventListener('click', openGraph);
  btnSave.addEventListener('click', saveCurrent);

  // ===== åˆæœŸåŒ– =====
  function init() {
    // åˆæœŸå€¤ï¼ˆä¾‹ï¼‰ï¼ša=4, b=5 â†’ V=220
    const a0 = 4.0;
    const b0 = 5.0;
    const V0 = calcV(a0, b0);

    inputA.value = fmt(a0);
    inputB.value = fmt(b0);
    inputV.value = fmt(V0);

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå›ºå®šãªã—
    fixedMode = 'none';
    updateFixedDisplay();
    setMessage('');

    // fixedMode=noneãªã®ã§Vã¯è‡ªå‹•è¨ˆç®—ã§æ•´åˆæ¸ˆã¿
    handleInput('a');
  }

  init();
</script>
</body>
</html>
